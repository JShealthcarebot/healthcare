
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>health care｜資料診斷工具</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei","Helvetica Neue",Arial,sans-serif;margin:24px;color:#111}
    h1{margin:0 0 8px}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 2px 8px rgba(0,0,0,.05)}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    code{background:#f7fafc; padding:2px 6px; border-radius:6px}
    button{padding:10px 12px; border-radius:10px; border:1px solid #d6e6ff; background:#eef5ff; cursor:pointer; font-weight:700}
    .ok{color:#065f46} .warn{color:#92400e}
  </style>
</head>
<body>
  <h1>health care｜資料診斷工具</h1>
  <p>用來檢查為什麼 <code>健康總覽</code> 看不到數據。此頁只讀/寫你的瀏覽器 <code>localStorage</code>。</p>

  <div class="card">
    <h2>目前登入者</h2>
    <div id="user"></div>
    <button id="btnSetUser">（可選）把登入者設為 admin</button>
  </div>

  <div class="card">
    <h2>可能的資料鍵</h2>
    <div id="keys"></div>
  </div>

  <div class="card">
    <h2>每個模組的欄位偵測</h2>
    <table id="probe"><thead><tr><th>模組</th><th>Key</th><th>日期欄位</th><th>卡路里/毫升欄位</th><th>樣本數</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h2>今日統計（以本地時區判斷）</h2>
    <div id="today"></div>
  </div>

  <div class="card">
    <h2>一鍵注入「今日」範例資料（安全測試）</h2>
    <p>會在 <code>hc_diet_&lt;user&gt;</code>、<code>hc_exercise_&lt;user&gt;</code>、<code>hc_water_&lt;user&gt;</code> 追加 1 筆資料；不會覆蓋原資料。</p>
    <button id="seed">注入範例資料</button>
    <span id="seedMsg"></span>
  </div>

<script>
  const byId = id=>document.getElementById(id);
  function localYMD(d){const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2);return `${y}-${m}-${da}`;}
  function toDateAny(s){
    if(!s) return null; if(s instanceof Date) return s;
    if(typeof s!=='string') return null;
    const t=s.trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return new Date(t+'T00:00:00');
    if(/^\d{4}\/\d{2}\/\d{2}$/.test(t)) return new Date(t.replaceAll('/','-')+'T00:00:00');
    const d=new Date(t); return isNaN(d)?null:d;
  }
  function num(v){ if(typeof v==='number') return v; if(typeof v==='string'){ const n=parseFloat(v.replace(/[^\d.-]/g,'')); return isNaN(n)?0:n;} return 0; }

  function pickKey(module, user){
    const exact=`hc_${module}_${user}`;
    if(localStorage.getItem(exact)!=null) return exact;
    let best=null, score=-1;
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i)||''; const v=localStorage.getItem(k)||'';
      const sc=(k.toLowerCase().includes(module)?2:0)+(k.toLowerCase().includes(user.toLowerCase())?2:0)+(v.trim().startsWith('[')?1:0);
      if(sc>score){ score=sc; best=k; }
    }
    return best;
  }
  function loadList(key){ try{ const a=JSON.parse(localStorage.getItem(key)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } }
  function probeFields(list, isWater){
    const dC=['date','datetime','time','timestamp','createdAt'];
    const kC=isWater?['ml','volume','amount','water','intakeMl']:['kcal','calories','cal','intake','consume','burned'];
    let dateKey=null, valKey=null;
    for(const it of list){
      if(!dateKey){ for(const k of dC){ if(k in it && toDateAny(it[k])){ dateKey=k; break; } } }
      if(!valKey){ for(const k of kC){ const v=it[k]; if(v!=null && !isNaN(parseFloat(String(v)))){ valKey=k; break; } } }
      if(dateKey && valKey) break;
    }
    return {dateKey,valKey};
  }

  function render(){
    const user = localStorage.getItem('hc_currentUser') || '(未登入)';
    byId('user').textContent = user;

    // 列出所有像樣的 key
    const lines=[];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i); const v = localStorage.getItem(k)||'';
      if(!v.trim().startsWith('[')) continue;
      lines.push(`<code>${k}</code> (len=${v.length})`);
    }
    byId('keys').innerHTML = lines.length? lines.join('<br>') : '<span class="warn">沒有找到陣列型的資料鍵。</span>';

    // 探測三模組
    const mods=[['diet',false],['exercise',false],['water',true]];
    const tbody = byId('probe').querySelector('tbody');
    tbody.innerHTML='';
    const today = localYMD(new Date());
    const todaySum = {in:0, ex:0, wat:0};
    for(const [mod,isWater] of mods){
      const key = pickKey(mod, user);
      const list = key ? loadList(key) : [];
      const pf = probeFields(list, isWater);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${mod}</td><td><code>${key||'-'}</code></td><td>${pf.dateKey||'-'}</td><td>${pf.valKey||'-'}</td><td>${list.length}</td>`;
      tbody.appendChild(tr);
      if(list.length && pf.dateKey && pf.valKey){
        for(const it of list){
          const d = toDateAny(it[pf.dateKey]);
          if(localYMD(d)===today){
            if(mod==='diet') todaySum.in += num(it[pf.valKey]);
            if(mod==='exercise') todaySum.ex += num(it[pf.valKey]);
            if(mod==='water') todaySum.wat += num(it[pf.valKey]);
          }
        }
      }
    }
    byId('today').innerHTML = `今日攝取：<b class="ok">${Math.round(todaySum.in)}</b> kcal，
      運動消耗：<b class="ok">${Math.round(todaySum.ex)}</b> kcal，
      淨值：<b class="ok">${Math.round(todaySum.in - todaySum.ex)}</b> kcal，
      飲水：<b class="ok">${Math.round(todaySum.wat)}</b> ml`;
  }

  byId('btnSetUser').onclick = ()=>{ localStorage.setItem('hc_currentUser','admin'); render(); };
  byId('seed').onclick = ()=>{
    const user = localStorage.getItem('hc_currentUser') || 'admin';
    const today = new Date(); const day = today.toISOString().slice(0,10);
    function push(key, obj){
      let arr=[]; try{ arr=JSON.parse(localStorage.getItem(key)||'[]'); if(!Array.isArray(arr)) arr=[]; }catch(_){}
      arr.push(obj); localStorage.setItem(key, JSON.stringify(arr));
    }
    push(`hc_diet_${user}`, { date: day, kcal: 600, name: "測試-早餐" });
    push(`hc_exercise_${user}`, { date: day, calories: 200, name: "測試-慢跑" });
    push(`hc_water_${user}`, { date: day, ml: 500 });
    byId('seedMsg').textContent = '已注入今天的測試資料，回健康總覽重整即可看到。';
    render();
  };

  render();
</script>
</body>
</html>
