
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>health care｜Overview 診斷工具</title>
  <style>
    :root{--text:#1f2937;--muted:#6b7280;--primary:#2b7cff;}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;
      margin:0;padding:24px;background:#f6fafc;color:var(--text)}
    h1{margin:0 0 10px 0}
    .row{display:grid;gap:10px;margin:12px 0}
    .card{background:#fff;border:1px solid #e5eefc;border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #eef2f7;font-size:14px}
    th{background:#f3f8ff;text-align:left;color:#315a9f}
    code{background:#f3f4f6;padding:2px 4px;border-radius:6px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #cfe0ff;background:#eaf3ff;color:#315a9f;font-weight:700;cursor:pointer}
    .btn.primary{background:#2b7cff;color:#fff;border-color:#2b7cff}
    .muted{color:var(--muted);font-size:12px}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:6px 10px;border-radius:8px;display:inline-block}
    .err{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d;padding:6px 10px;border-radius:8px;display:inline-block}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>健康總覽 診斷工具</h1>
  <div class="muted">查看目前瀏覽器 localStorage 內容、偵測到的 key 與欄位，並可注入測試資料。</div>

  <div class="row grid">
    <div class="card">
      <h3>登入者</h3>
      <div>hc_currentUser：<code id="currentUser">（未登入）</code></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" id="setAdmin">把登入者設為 admin</button>
        <button class="btn" id="setSamelo">把登入者設為 samelo</button>
        <button class="btn" id="reload">重新整理</button>
      </div>
      <div class="muted" style="margin-top:8px">本工具僅修改 localStorage，不會呼叫後端。</div>
    </div>

    <div class="card">
      <h3>今日統計（依偵測結果）</h3>
      <div>攝取：<b id="tIntake">0</b> kcal　｜　消耗：<b id="tBurn">0</b> kcal　｜　飲水：<b id="tWater">0</b> ml</div>
      <div style="margin-top:6px">淨值（攝取-消耗）：<b id="tNet">0</b> kcal</div>
      <div id="todayMsg" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="row card">
    <h3>localStorage 陣列鍵（摘要）</h3>
    <table>
      <thead>
        <tr><th>Key</th><th>長度</th><th>第一筆摘要</th></tr>
      </thead>
      <tbody id="keysBody">
        <tr><td colspan="3" class="muted">沒有找到陣列型資料。</td></tr>
      </tbody>
    </table>
  </div>

  <div class="row grid">
    <div class="card">
      <h3>偵測結果：飲食（diet）</h3>
      <div>使用的 key：<code id="dietKey" class="mono">—</code></div>
      <div>日期欄位：<code id="dietDate">—</code>　｜　卡路里欄位：<code id="dietVal">—</code></div>
      <div id="dietCount" class="muted" style="margin-top:6px"></div>
    </div>
    <div class="card">
      <h3>偵測結果：運動（exercise）</h3>
      <div>使用的 key：<code id="exKey" class="mono">—</code></div>
      <div>日期欄位：<code id="exDate">—</code>　｜　卡路里欄位：<code id="exVal">—</code></div>
      <div id="exCount" class="muted" style="margin-top:6px"></div>
    </div>
    <div class="card">
      <h3>偵測結果：飲水（water）</h3>
      <div>使用的 key：<code id="waterKey" class="mono">—</code></div>
      <div>日期欄位：<code id="waterDate">—</code>　｜　毫升欄位：<code id="waterVal">—</code></div>
      <div id="waterCount" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="row card">
    <h3>工具</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="inject">注入「今日」示範資料（飲食+運動+飲水各 1 筆）</button>
      <button class="btn" id="clearSamples">清除本工具注入的示範資料</button>
      <button class="btn" id="openOverview">打開 overview.html 測試</button>
    </div>
    <div class="muted" style="margin-top:8px">示範資料會加入至 <code>hc_diet_&lt;user&gt;</code> / <code>hc_exercise_&lt;user&gt;</code> / <code>hc_water_&lt;user&gt;</code>；不會覆蓋你既有資料。</div>
  </div>

<script>
(function(){
  function localYMD(d){const y=d.getFullYear();const m=('0'+(d.getMonth()+1)).slice(-2);const da=('0'+d.getDate()).slice(-2);return y+'-'+m+'-'+da;}
  function toDateAny(s){if(!s) return null; if(s instanceof Date) return s; if(typeof s!=='string') return null; const t=s.trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return new Date(t+'T00:00:00'); if(/^\d{4}\/\d{2}\/\d{2}$/.test(t)) return new Date(t.replaceAll('/','-')+'T00:00:00'); const d=new Date(t); return isNaN(d)?null:d;}
  function num(v){if(typeof v==='number') return v; if(typeof v==='string'){const n=parseFloat(v.replace(/[^\d.-]/g,'')); return isNaN(n)?0:n;} return 0;}
  function within(d,s,e){if(!d) return false; if(s && d<s) return false; if(e && d>e) return false; return true;}

  const els = {
    user: document.getElementById('currentUser'),
    keysBody: document.getElementById('keysBody'),
    tIn: document.getElementById('tIntake'),
    tEx: document.getElementById('tBurn'),
    tNet: document.getElementById('tNet'),
    tWat: document.getElementById('tWater'),
    todayMsg: document.getElementById('todayMsg'),
    dietKey: document.getElementById('dietKey'), dietDate: document.getElementById('dietDate'), dietVal: document.getElementById('dietVal'), dietCount: document.getElementById('dietCount'),
    exKey: document.getElementById('exKey'), exDate: document.getElementById('exDate'), exVal: document.getElementById('exVal'), exCount: document.getElementById('exCount'),
    waterKey: document.getElementById('waterKey'), waterDate: document.getElementById('waterDate'), waterVal: document.getElementById('waterVal'), waterCount: document.getElementById('waterCount'),
  };

  function pickKey(module, user){
    const exact = `hc_${module}_${user}`;
    if(localStorage.getItem(exact)!=null) return exact;
    let best=null, score=-1;
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i)||''; const v=localStorage.getItem(k)||'';
      const sc=(k.toLowerCase().includes(module)?2:0)+(k.toLowerCase().includes(user.toLowerCase())?2:0)+(v.trim().startsWith('[')?1:0);
      if(sc>score){ score=sc; best=k; }
    }
    return best;
  }
  function loadList(key){ try{ const a=JSON.parse(localStorage.getItem(key)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } }
  function probeFields(list, isWater){
    const dC=['date','datetime','time','timestamp','createdAt','日期'];
    const kC=isWater?['ml','volume','amount','water','intakeMl','毫升']:['kcal','calories','cal','intake','consume','burned','energy','卡路里'];
    let dateKey=null, valKey=null;
    for(const it of list){
      if(!it||typeof it!=='object') continue;
      if(!dateKey){ for(const k of dC){ if(k in it && toDateAny(it[k])){ dateKey=k; break; } } }
      if(!valKey){ for(const k of kC){ const v=it[k]; if(v!=null && !isNaN(parseFloat(String(v)))){ valKey=k; break; } } }
      if(dateKey && valKey) break;
    }
    return {dateKey, valKey};
  }

  function renderKeys(){
    const rows=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      let v=localStorage.getItem(k)||'';
      let len='—', first='—';
      try{
        const parsed=JSON.parse(v);
        if(Array.isArray(parsed)){
          len=parsed.length;
          first = parsed.length? JSON.stringify(parsed[0]).slice(0,120): '（空）';
          rows.push(`<tr><td class="mono">${k}</td><td>${len}</td><td class="mono">${first}</td></tr>`);
        }
      }catch(_){}
    }
    els.keysBody.innerHTML = rows.length? rows.join('') : '<tr><td colspan="3" class="muted">沒有找到陣列型資料。</td></tr>';
  }

  function calcToday(){
    const user = localStorage.getItem('hc_currentUser') || '（未設定）';
    els.user.textContent = user;

    const dietKey = pickKey('diet', user);
    const exKey   = pickKey('exercise', user);
    const watKey  = pickKey('water', user);

    const diet = dietKey? loadList(dietKey): [];
    const ex   = exKey?   loadList(exKey):   [];
    const wat  = watKey?  loadList(watKey):  [];

    const fd = probeFields(diet, false);
    const fe = probeFields(ex, false);
    const fw = probeFields(wat, true);

    els.dietKey.textContent = dietKey || '（未找到）';
    els.exKey.textContent   = exKey   || '（未找到）';
    els.waterKey.textContent= watKey  || '（未找到）';
    els.dietDate.textContent= fd.dateKey || '—';
    els.dietVal.textContent = fd.valKey  || '—';
    els.exDate.textContent  = fe.dateKey || '—';
    els.exVal.textContent   = fe.valKey  || '—';
    els.waterDate.textContent= fw.dateKey || '—';
    els.waterVal.textContent = fw.valKey  || '—';
    els.dietCount.textContent = `樣本數：${diet.length}`;
    els.exCount.textContent   = `樣本數：${ex.length}`;
    els.waterCount.textContent= `樣本數：${wat.length}`;

    const today = localYMD(new Date());
    const tIn = diet.reduce((s,it)=> (localYMD(toDateAny(it?.[fd.dateKey]))===today? s+num(it?.[fd.valKey]) : s), 0);
    const tEx = ex.reduce((s,it)=>   (localYMD(toDateAny(it?.[fe.dateKey]))===today? s+num(it?.[fe.valKey]) : s), 0);
    const tWt = wat.reduce((s,it)=>  (localYMD(toDateAny(it?.[fw.dateKey]))===today? s+num(it?.[fw.valKey]) : s), 0);

    els.tIn.textContent = Math.round(tIn);
    els.tEx.textContent = Math.round(tEx);
    els.tNet.textContent= Math.round(tIn - tEx);
    els.tWat.textContent= Math.round(tWt);

    // 訊息
    const msgs=[];
    if(!dietKey) msgs.push('找不到飲食資料 key');
    if(dietKey && (!fd.dateKey || !fd.valKey)) msgs.push('飲食資料缺日期或卡路里欄位');
    if(!exKey) msgs.push('找不到運動資料 key');
    if(exKey && (!fe.dateKey || !fe.valKey)) msgs.push('運動資料缺日期或卡路里欄位');
    if(!watKey) msgs.push('找不到飲水資料 key（這不影響淨值計算）');
    els.todayMsg.innerHTML = msgs.length? `<div class="err">${msgs.join('；')}</div>` : '<div class="ok">偵測成功！總覽應可正常顯示。</div>';
  }

  function injectSamples(){
    let user = localStorage.getItem('hc_currentUser');
    if(!user){ alert('尚未設定登入者，將把登入者設為 admin。'); user='admin'; localStorage.setItem('hc_currentUser','admin'); }
    const today = new Date(); const day = localYMD(today);

    const dk = `hc_diet_${user}`; const ek = `hc_exercise_${user}`; const wk = `hc_water_${user}`;
    let d = []; let e = []; let w = [];
    try{ d = JSON.parse(localStorage.getItem(dk)||'[]'); if(!Array.isArray(d)) d=[]; }catch(_){ d=[]; }
    try{ e = JSON.parse(localStorage.getItem(ek)||'[]'); if(!Array.isArray(e)) e=[]; }catch(_){ e=[]; }
    try{ w = JSON.parse(localStorage.getItem(wk)||'[]'); if(!Array.isArray(w)) w=[]; }catch(_){ w=[]; }

    d.push({ date: day, calories: 600, note: '診斷工具示範' });
    e.push({ date: day, calories: 200, note: '診斷工具示範' });
    w.push({ date: day, ml: 500, note: '診斷工具示範' });

    localStorage.setItem(dk, JSON.stringify(d));
    localStorage.setItem(ek, JSON.stringify(e));
    localStorage.setItem(wk, JSON.stringify(w));

    alert('已注入今日示範資料！');
    renderKeys(); calcToday();
  }

  function clearSamples(){
    const user = localStorage.getItem('hc_currentUser') || 'admin';
    const dk = `hc_diet_${user}`; const ek=`hc_exercise_${user}`; const wk=`hc_water_${user}`;
    function removeTag(arr){
      return arr.filter(x => x?.note !== '診斷工具示範');
    }
    try{ const a=JSON.parse(localStorage.getItem(dk)||'[]'); localStorage.setItem(dk, JSON.stringify(removeTag(Array.isArray(a)?a:[]))); }catch(_){}
    try{ const a=JSON.parse(localStorage.getItem(ek)||'[]'); localStorage.setItem(ek, JSON.stringify(removeTag(Array.isArray(a)?a:[]))); }catch(_){}
    try{ const a=JSON.parse(localStorage.getItem(wk)||'[]'); localStorage.setItem(wk, JSON.stringify(removeTag(Array.isArray(a)?a:[]))); }catch(_){}
    alert('已清除本工具注入的示範資料。'); renderKeys(); calcToday();
  }

  // Buttons
  document.getElementById('setAdmin').onclick = ()=>{ localStorage.setItem('hc_currentUser','admin'); calcToday(); };
  document.getElementById('setSamelo').onclick = ()=>{ localStorage.setItem('hc_currentUser','samelo'); calcToday(); };
  document.getElementById('reload').onclick = ()=> location.reload();
  document.getElementById('inject').onclick = injectSamples;
  document.getElementById('clearSamples').onclick = clearSamples;
  document.getElementById('openOverview').onclick = ()=> window.open('overview.html','_blank');

  // init
  renderKeys(); calcToday();
})();
</script>
</body>
</html>
